"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyCompileNode=void 0;const code_type_enum_js_1=require("../../enum/code-type-enum.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),compile_node_js_1=require("../compile-node.js"),path_1=__importDefault(require("path")),legacy_generate_js_manifest_js_1=require("./legacy-generate-js-manifest.js"),legacy_generate_loader_json_js_1=require("./legacy-generate-loader-json.js"),task_names_js_1=require("../common/task-names.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),lodash_1=require("lodash"),file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js"),fs_extra_1=__importDefault(require("fs-extra")),legacy_hook_compile_resource_js_1=require("./hook/legacy-hook-compile-resource.js"),ability_type_enum_js_1=require("../../enum/ability-type-enum.js");class LegacyCompileNode extends compile_node_js_1.CompileNode{constructor(e,t){super(e,t,task_names_js_1.TaskNames.LegacyFATask.COMPILE_NODE),this.manifestDir=this.pathInfo.getIntermediatesLegacyManifestJson();const s=this.moduleModel.getModuleType()===module_type_enum_js_1.ModuleType.Feature?this.service.getRelatedEntryModules()[0]:"";this.resourceTablePath=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),s,build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT)}declareInputs(){return super.declareInputs()}declareOutputFiles(){return(new file_set_js_1.FileSet).addEntry(this.aceModuleBuild,{isDirectory:!0})}declareInputFiles(){const e=(new file_set_js_1.FileSet).addEntry(this.manifestDir,{isDirectory:!0}).addEntry(this.aceBuildJsonDir,{isDirectory:!0}).addEntry(this.resourceTablePath).addEntries(this.getAllExistDependentMainPath()).addEntries(this.getAllExistHarSrcPath(),{isDirectory:!0});return this.sourcePath&&fs_extra_1.default.existsSync(this.sourcePath)&&e.addEntry(this.sourcePath,{isDirectory:!0}),e}initTaskDepends(){this.module.registryDependsOnTask(this,new legacy_generate_js_manifest_js_1.LegacyGenerateJsManifest(this.targetService),new legacy_hook_compile_resource_js_1.LegacyHookCompileResource(this.targetService),new legacy_generate_loader_json_js_1.LegacyGenerateLoaderJson(this.targetService))}taskShouldDo(e){return!this.service.hasLiteDevice()&&super.taskShouldDo(e)}doTaskAction(e){const t=this.moduleModel.getLegacyAbilities(e.getTargetName());for(let s=0;s<t.length;s++){const a=t[s];if(a.getSrcLanguage()!==this.codeType)continue;const i={...this.commonOption,abilityType:a.getType(),aceManifestPath:path_1.default.resolve(this.manifestDir,a.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LEGACY_MANIFEST_JSON),appResource:this.resourceTablePath,aceModuleRoot:path_1.default.resolve(this.sourcePath,a.getRelateSrcPath()),aceModuleBuild:path_1.default.resolve(this.aceModuleBuild,a.getRelateSrcPath()),cachePath:path_1.default.resolve(this.getTaskTempDir(e),a.getRelateSrcPath()),aceSuperVisualPath:path_1.default.resolve(this.aceSuperVisualPath,a.getRelateSrcPath()),aceBuildJson:path_1.default.resolve(this.aceBuildJsonDir,a.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LOADER_JSON)};this.doRealLoaderCompile(i,((e,t)=>{this.moveReleaseMap(e,t)}),[e,`js/${a.getRelateSrcPath()}`],[0,1])}this.compileTestRunner(e)}compileTestRunner(e){var t,s,a;const i=null===(a=null===(s=null===(t=this.moduleModel.getSourceSetByTargetName(e.getTargetName()).getLegacyModuleTargetRes().getConfigJsonOpt())||void 0===t?void 0:t.module)||void 0===s?void 0:s.testRunner)||void 0===a?void 0:a.srcPath;if("ohosTest"!==e.getTargetName()||void 0===i||this.codeType!==code_type_enum_js_1.CodeType.JS)return;const o={...this.commonOption,abilityType:ability_type_enum_js_1.AbilityTypeEnum.TEST_RUNNER,appResource:this.resourceTablePath,aceModuleRoot:path_1.default.resolve(this.sourcePath,i),aceModuleBuild:path_1.default.resolve(this.aceModuleBuild,i),cachePath:path_1.default.resolve(this.getTaskTempDir(e),i)};this.doRealLoaderCompile(o,lodash_1.noop,[],[0,1])}}exports.LegacyCompileNode=LegacyCompileNode;