"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyCompileLiteNode=void 0;const code_type_enum_js_1=require("../../enum/code-type-enum.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),compile_node_js_1=require("../compile-node.js"),path_1=__importDefault(require("path")),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),hvigor_base_1=require("@ohos/hvigor-base"),legacy_generate_js_manifest_js_1=require("./legacy-generate-js-manifest.js"),legacy_compile_resource_js_1=require("./legacy-compile-resource.js"),common_const_js_1=require("../../const/common-const.js"),node_command_builder_js_1=require("../../builder/node-command-builder.js"),process_utils_js_1=require("../../utils/process-utils.js"),file_util_js_1=require("../../utils/file-util.js"),fs_extra_1=__importDefault(require("fs-extra")),legacy_generate_loader_json_js_1=require("./legacy-generate-loader-json.js"),task_names_js_1=require("../common/task-names.js");class LegacyCompileLiteNode extends compile_node_js_1.CompileNode{constructor(e){super(e,code_type_enum_js_1.CodeType.JS,task_names_js_1.TaskNames.LegacyFATask.COMPILE_LITE_NODE),this.debuggable=hvigor_base_1.hvigor.getExtraConfig().get(common_const_js_1.CommonConst.DEBUGGABLE),this._logger=ohos_logger_js_1.OhosLogger.getLogger(LegacyCompileLiteNode.name)}taskShouldDo(e){return this.service.hasLiteDevice()}initTaskDepends(){this.module.registryDependsOnTask(this,new legacy_generate_js_manifest_js_1.LegacyGenerateJsManifest(this.service),new legacy_compile_resource_js_1.LegacyCompileResource(this.service),new legacy_generate_loader_json_js_1.LegacyGenerateLoaderJson(this.service))}doTaskAction(e){const t=this.service.getModuleModel(),s=t.getSourceSetByTargetName(e.getTargetName()).getCodeMap().get(this.codeType);if(void 0===s)return void this._logger.errorMessageExit("Lite wearable only support JS.");const o=s.getSrcPath(),i=e.getPathInfo(),a=path_1.default.resolve(i.getIntermediatesLegacyManifestJson()),r=path_1.default.resolve(e.getPathInfo().getIntermediatesAssetsPath(),code_type_enum_js_1.CodeType.JS),_=t.getLegacyAbilities(e.getTargetName());file_util_js_1.FileUtil.checkDirWithoutDelete(i.getIntermediatesLiteBinSource()),fs_extra_1.default.copySync(t.getSourceSetByTargetName().getLegacyModuleTargetRes().getResourcePath(),i.getIntermediatesLiteBinSource(),{filter:e=>fs_extra_1.default.statSync(e).isDirectory()||e.toLowerCase().endsWith(".png")||e.toLowerCase().endsWith(".jpg"),recursive:!0});for(let t=0;t<_.length;t++){const s=_[t],l={...this.commonOption,abilityType:s.getType(),aceManifestPath:path_1.default.resolve(a,s.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LEGACY_MANIFEST_JSON),aceModuleRoot:path_1.default.resolve(o,s.getRelateSrcPath()),aceModuleBuild:path_1.default.resolve(r,s.getRelateSrcPath()),hapMode:this.debuggable,img2bin:"true",iconPath:i.getIntermediatesLiteBinSource(),cachePath:this.getTaskTempDir(e),aceBuildJson:path_1.default.resolve(i.getIntermediatesLoaderPath(),s.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LOADER_JSON)};this.doRealLoaderCompile(this.sdkInfo.getJsLoader(),l),this.moveReleaseMap(e,`js/${s.getRelateSrcPath()}`)}}doRealLoaderCompile(e,t){const s=new node_command_builder_js_1.NodeCommandBuilder(!0).addWebpackPath("./node_modules/webpack/bin/webpack.js").addWebpackConfig(common_const_js_1.CommonConst.ACE_LITE_WEBPACK_FILE).addBuildMode(void 0===this.debuggable||"false"!==this.debuggable);this._logger._printDebugCommand("NodeEnv",t),this._logger._printDebugCommand("lite-loader",s.build());const o={cwd:e,env:t};new process_utils_js_1.ProcessUtils(this.moduleName,this.name).executeSync(s.build(),o)}}exports.LegacyCompileLiteNode=LegacyCompileLiteNode;