"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,s,t,r){void 0===r&&(r=t);var i=Object.getOwnPropertyDescriptor(s,t);i&&!("get"in i?!s.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return s[t]}}),Object.defineProperty(e,r,i)}:function(e,s,t,r){void 0===r&&(r=t),e[r]=s[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,s){Object.defineProperty(e,"default",{enumerable:!0,value:s})}:function(e,s){e.default=s}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var s={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(s,e,t);return __setModuleDefault(s,e),s},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TransformClass=void 0;const fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),os_1=__importDefault(require("os")),d8_options_js_1=require("../../builder/inner-java-command-builder/d8-options.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),process_utils_js_1=require("../../utils/process-utils.js"),runtime_type_enum_js_1=require("../../enum/runtime-type-enum.js"),ohos_shell_hap_task_js_1=require("./ohos-shell-hap-task.js"),task_names_js_1=require("../common/task-names.js"),compile_java_with_javac_js_1=require("./compile-java-with-javac.js");var ShellTask=task_names_js_1.TaskNames.ShellTask;class TransformClass extends ohos_shell_hap_task_js_1.OhosShellHapTask{constructor(e){super(e,ShellTask.TRANSFORM_SHELL_CLASSES),this._log=ohos_logger_js_1.OhosLogger.getLogger(TransformClass.name)}initTaskDepends(){this.module.registryDependsOnTask(this,new compile_java_with_javac_js_1.CompileJavaWithJavac(this.service))}taskShouldDo(e){return e.getTargetStatus().is(runtime_type_enum_js_1.RuntimeTypeEnum.HARMONY_OS)}beforeTask(e){fse.emptyDirSync(e.getPathInfo().getIntermediatesDexDir()),fse.emptyDirSync(e.getPathInfo().getIntermediatesShellDexDir())}doTaskAction(e){const s=e.getPathInfo();this.transformClass(s.getIntermediatesClassDir(),s.getIntermediatesDexDir(),[this.getHosSdkInfo().getOhosJar()]),this.transformClass(s.getIntermediatesShellClassDir(),s.getIntermediatesShellDexDir(),[this.getHosSdkInfo().getOhosJar()])}transformClass(e,s,t){const r=path_1.default.resolve(e,"classesFile");this.generateClassesFiles(e,r);const i=new d8_options_js_1.D8Options;i.addJvmOption("-Xmx1024M").addJvmOption("-Xss1m").addClassPath(this.getHosSdkInfo().getD8Jar()).addMainClass("com.android.tools.r8.D8"),i.addInputDir(r).addOutputDir(s);for(let e=0;e<t.length;e++)i.addLib(t[e]);this._log.debug(i.build()),(new process_utils_js_1.ProcessUtils).executeSync(i.build(),{stdout:"ignore",stderr:"ignore"})}generateClassesFiles(e,s){const t=this.listFile(e,[],new RegExp(/\.class$/)).join(os_1.default.EOL);this._log.debug("==========class files=========="),this._log.debug(t),fse.outputFileSync(s,t)}listFile(e,s,t){if(!fse.existsSync(e)||!fse.statSync(e).isDirectory())return[];return fse.readdirSync(e).forEach((r=>{const i=path_1.default.join(e,r);if(fse.statSync(i).isDirectory())this.listFile(i,s,t);else{if(t&&!t.test(r))return;s.push(i)}})),s}}exports.TransformClass=TransformClass;